{% extends "layout.html" %} {% set active_page = "leads" %} {% block content %}

<form class="form-new-lead" method="POST">
  {{ form.hidden_tag() }}
  <!-- security 'csrf' token -->
  <div
    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
  >
    <h2 class="h4">{% if title %}{{title}}{% else %}No Title{% endif %}</h2>
    <div class="btn-toolbar mb-2 mb-md-0">
      {{ form.submit(class="btn btn-md btn-outline-info mr-2") }}
      {% if not lead_id %}
      <input type="reset" class="btn btn-md btn-outline-secondary mr-2" />
      {% endif %}
      <a
        href="{{ url_for('leads.get_leads_view') }}"
        class="btn btn-md btn-outline-secondary"
        role="button"
      >
        <span data-feather="arrow-left"></span>
        Powrót do listy zleceń
      </a>
    </div>
  </div>
  <div class="row">
    <div class="col-9">
      <div class="form-row mb-3">
        <div class="col">
          {{ form.bike_manufacturer.label(class="form-control-label") }} {% if
          form.bike_manufacturer.errors %} {{
          form.bike_manufacturer(class="form-control form-control-lg required
          is-invalid") }}
          <div class="invalid-feedback">
            {% for error in form.first_name.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% else %} {{ form.bike_manufacturer(class="form-control required
          from-control-lg", placeholder="Marka roweru ...") }} {% endif %}
        </div>
        <div class="col">
          {{ form.bike_model.label(class="form-control-label") }} {% if
          form.bike_model.errors %} {{ form.bike_model(class="form-control
          form-control-lg required is-invalid") }}
          <div class="invalid-feedback">
            {% for error in form.bike_model.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% else %} {{ form.bike_model(class="form-control required
          from-control-lg", placeholder="Model roweru ...") }} {% endif %}
        </div>
      </div>
      <div class="form-group">
        {{ form.title.label(class="form-control-label") }} {{
        form.title(class="form-control from-control-lg") }}
        <script>
          $(document).ready(function () {
            $("#bike_manufacturer, #bike_model").on("input", function () {
              $.ajax({
                url: "/leads/new/_autoset_title",
                data: {
                  bike_manufacturer: $("#bike_manufacturer").val(),
                  bike_model: $("#bike_model").val(),
                },
                type: "POST",
                success: function (response) {
                  $("#title").val(response.new_value);
                },
                error: function (error) {
                  console.log(error);
                },
              });
            });
          });
        </script>
      </div>

      <div class="form-row mb-3">
        <div class="col">
          {{ form.first_name.label(class="form-control-label") }} {% if
          form.first_name.errors %} {{ form.first_name(class="form-control
          form-control-lg required is-invalid") }}
          <div class="invalid-feedback">
            {% for error in form.first_name.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% else %} {{ form.first_name(class="form-control required
          from-control-lg", placeholder="Imię ...") }} {% endif %}
        </div>
        <div class="col">
          {{ form.last_name.label(class="form-control-label") }} {% if
          form.last_name.errors %} {{ form.last_name(class="form-control
          form-control-lg required is-invalid") }}
          <div class="invalid-feedback">
            {% for error in form.last_name.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% else %} {{ form.last_name(class="form-control required
          from-control-lg", placeholder="Nazwisko ...") }} {% endif %}
        </div>
      </div>

      <div class="form-row mb-3">
        <div class="col">
          {{ form.phone.label(class="form-control-label") }} {% if
          form.phone.errors %} {{ form.phone(class="form-control form-control-lg
          required is-invalid") }}
          <div class="invalid-feedback">
            {% for error in form.phone.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% else %} {% if not form.phone.data %} {{
          form.phone(class="form-control required from-control-lg",
          placeholder="Telefon ...", value="+48") }} {% else %} {{
          form.phone(class="form-control required from-control-lg",
          placeholder="Telefon ...") }} {% endif %} {% endif %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-6">
          {{ form.lead_status.label(class="form-control-label") }} {{
          form.lead_status(class="form-control from-control-lg") }}
        </div>
        <div class="form-group col-6">
          {{ form.date_scheduled.label(class="form-control-label") }} {{
          form.date_scheduled(class="form-control from-control-lg") }}
        </div>
        <script>
          window.handleDropdownChange = function () {
            var dropdown = document.getElementById("lead_status");
            var selectedValue = dropdown.options[dropdown.selectedIndex].value;
            var calendarEl = document.getElementById("calendar");
            var calendar_row = document.getElementById("calendar_row");
            var date_scheduled = document.getElementById("date_scheduled");
            //date_scheduled.value = "";
            var calendar = new FullCalendar.Calendar(calendarEl, {
              //plugins: [ interactionPlugin, dayGridPlugin ],
              initialView: "dayGridWeek",
              locale: "pl",
              selectable: true,
              height: 400,
              select: function (info) {
                // Get the selected date and format it as yyyy-mm-dd
                var selectedDate = moment(info.start).format("YYYY-MM-DD");

                // Store the selected date in a hidden input field
                document.getElementById("date_scheduled").value = selectedDate;
              },
              events: {
                url: "/leads/get_scheduled",
                method: "GET",
              },
            });
            if (selectedValue === "2") {
              calendar_row.style.display = "block";
              calendar.render();
            } else {
              if (calendar) {
                calendar.render();
                calendar.destroy();
                calendar_row.style.display = "none";
              }
            }
          };
        </script>
        <script>
          var dropdown = document.getElementById("lead_status");
          dropdown.addEventListener("change", window.handleDropdownChange);
        </script>
      </div>
      <div class="form-row" id="calendar_row" style="display: none">
        <div class="col">
          <label for="calendar">Kalendarz:</label>
          <div id="calendar"></div>
          <br />
        </div>
      </div>

      {% if current_user.is_admin %}
      <div class="form-row">
        <div class="form-group col-6">
          {{ form.assignees.label(class="form-control-label") }} {{
          form.assignees(class="form-control from-control-lg") }}
        </div>
      </div>
      {% endif %}

      <div class="form-group">
        {{ form.notes.label(class="form-control-label") }} {{
        form.notes(class="form-control from-control-lg") }}
      </div>
      <div class="form-row">
        <label>Cena całkowita serwisu:</label>
      </div>
      <div class="form-row">
        <div class="form-group col-6">
          <div class="form-control from-control-lg" id="total-service-price">{{ form.total_price.data if form.total_price.data else '0' }}</div> 
        </div>
        <div class="form-group col-6", style="display: table-cell;vertical-align: middle;font-size: 20px;">
          zł
        </div>
      </div>           
      <div class="form-row">
        <label>Czynnośći serwisowe:</label>
      </div>
      <div id="inputs-container"></div>
      <button class="btn btn-md btn-outline-secondary" id="add-input-button", type="button">
        Dodaj czynność serwisową
      </button>
      <script>
        function generateForm(inputId, service_name=null, service_price=null) {

            const search = document.createElement('input');
            search.type = 'text';
            search.className = "form-control required from-control-lg"
            search.id = inputId;
            search.name ='service_name';
            search.value = service_name
            const search_input_div = document.createElement('div')
            search_input_div.className = "form-group col-6"
            search_input_div.appendChild(search)

            const price = document.createElement('input');
            price.type = 'text';
            price.className = "form-control required from-control-lg"
            price.id = inputId + '-price';
            price.name = 'service_price';
            price.value=service_price
            const price_input_div = document.createElement('div')
            price_input_div.className = "form-group col-1"
            price_input_div.appendChild(price)

            const search_container_div = document.createElement('div');
            search_container_div.className = "search-container"
            const form_row_div = document.createElement('div');
            form_row_div.className = "form-row"
            form_row_div.id = inputId + '-row'

            const currency_div = document.createElement('div');
            currency_div.className = "form-group col-1"
            currency_div.innerHTML = 'zł'
            currency_div.style = "display: table-cell;vertical-align: middle;font-size: 20px;"

            
            const delete_button = document.createElement('a');
            delete_button.id = inputId + '-del-button';
            delete_button.className = "btn btn-md btn-outline-secondary"
            delete_button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>'
            delete_button.type = "button"
            const delete_button_div = document.createElement('div')
            delete_button_div.className = "form-group col-1"
            delete_button_div.appendChild(delete_button)

            const dropdown_div = document.createElement('div');
            dropdown_div.id = inputId + '-dropdown';

            form_row_div.appendChild(search_input_div);
            form_row_div.appendChild(price_input_div)
            form_row_div.appendChild(currency_div)
            form_row_div.appendChild(delete_button_div)
            search_container_div.appendChild(form_row_div)
            search_container_div.appendChild(dropdown_div)

            return search_container_div
        }
        $(document).ready(function () {
          $("#add-input-button").on("click", function () {
            var inputId = "search-input-" + Date.now();
            var inputWithDropdownHtml = generateForm(inputId)
            $("#inputs-container").append(inputWithDropdownHtml);
            $("#" + inputId + "-del-button").on("click", function () {
              var search = document.getElementById(inputId)
              search.value = ''
              var input_row = document.getElementById(inputId + '-row')
              input_row.style.display = "none";
              var total_price = Math.round(parseFloat(document.getElementById("total-service-price").innerHTML) * 1000 / 1000);
              var deleted_price = Math.round(parseFloat(document.getElementById(inputId + "-price").value) * 1000 / 1000);
              total_price -= deleted_price 
              document.getElementById("total-service-price").innerHTML = total_price
            });
            $("#" + inputId).on("input", function () {
              var query = $(this).val();
              if (query.length >= 3) {
                $.ajax({
                  url: "/leads/new/suggest_service",
                  data: { query: query },
                  success: function (response) {
                    var dropdown = $("#" + inputId + "-dropdown");
                    dropdown.html("");
                    if (response.length > 0) {
                      for (var i = 0; i < response.length; i++) {
                        dropdown.append(
                          '<a class="dropdown-item" href="#">' +
                            response[i] +
                            "</a>"
                        );
                      }
                      dropdown.addClass("show");
                    } else {
                      dropdown.removeClass("show");
                    }
                  },
                });
              } else {
                $("#" + inputId + "-dropdown").removeClass("show");
              }
            });

            // Toggle the 'show' class on the dropdown element when it's clicked
            $("#" + inputId + "-dropdown").on(
              "click",
              ".dropdown-item",
              function () {
                var selectedValue = $(this).text();
                $.ajax({
                  url: "/leads/new/get_service_price",
                  data: { query: selectedValue },
                  success: function (response) {
                      $("#" + inputId + '-price').val(response);
                      var total_price = Math.round(parseFloat(document.getElementById("total-service-price").innerHTML) * 1000 / 1000);
                      if (!total_price){
                        total_price = 0
                      } 
                      total_price += Math.round(parseFloat(response) * 1000 / 1000);
                      document.getElementById("total-service-price").innerHTML = total_price
                  },
                });
                $("#" + inputId).val(selectedValue);
                var dd = $("#" + inputId + "-dropdown");
                dd[0].style.display = 'none';
              }
            );
          });
        });
      </script>
      <script>
      $(document).ready(function () {
          lead_id = "{{ lead_id }}"
          if (lead_id){
                $.ajax({
                  url: "/leads/{{ lead_id }}/get_services",
                  success: function (response) {
                    for (const service of response) {
                      var inputId = "search-input-" + Date.now();
                      var inputWithDropdownHtml = generateForm(inputId, service.name, service.price)
                      $("#inputs-container").append(inputWithDropdownHtml);
                    }
                    $("#" + inputId + "-del-button").on("click", function () {
                      var search = document.getElementById(inputId)
                      search.value = ''
                      var input_row = document.getElementById(inputId + '-row')
                      input_row.style.display = "none";
                      var total_price = Math.round(parseFloat(document.getElementById("total-service-price").innerHTML) * 1000 / 1000);
                      var deleted_price = Math.round(parseFloat(document.getElementById(inputId + "-price").value) * 1000 / 1000);
                      total_price -= deleted_price 
                      document.getElementById("total-service-price").innerHTML = total_price
                    });
                  },
                });

          }
              });
      </script>
    </div>
  </div>
</form>
{% endblock %}
